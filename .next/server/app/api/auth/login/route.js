"use strict";(()=>{var e={};e.id=873,e.ids=[873],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},735:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>_,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{POST:()=>d});var s=a(9303),r=a(8716),i=a(670),o=a(7070),u=a(8189),c=a(1615);async function d(e){try{let{username:t,password:a}=await e.json();if(!t||!a)return o.NextResponse.json({error:"Missing credentials"},{status:400});let n=await u.e8.login(t,a);if(!n)return o.NextResponse.json({error:"Invalid credentials"},{status:401});return(0,c.cookies)().set("session_user",JSON.stringify({id:n.id,username:n.username,role:n.role}),{httpOnly:!0,secure:!0,sameSite:"strict",maxAge:604800}),o.NextResponse.json({success:!0,user:{id:n.id,username:n.username,role:n.role}})}catch(e){return console.error("Login error:",e),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\diji.dev\\source\\repos\\FX\\CopyPoz\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h}=l,_="/api/auth/login/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},8189:(e,t,a)=>{a.d(t,{e8:()=>o,yt:()=>u,mD:()=>c});let n=require("@prisma/client"),s=globalThis.prisma||new n.PrismaClient({log:["query","error","warn"]});var r=a(6113),i=a(2023);class o{static async findUser(e){return s.user.findFirst({where:{OR:[{username:e},{email:e}]}})}static async verifyPassword(e,t){if(await i.compare(t,e.password_hash))return!0;let a=(0,r.createHash)("sha256").update(t).digest("hex");if(e.password_hash===a){let a=await i.hash(t,10);return await s.user.update({where:{id:e.id},data:{password_hash:a}}),!0}return!1}static async login(e,t){let a=await this.findUser(e);if(!a||"active"!==a.status||!await this.verifyPassword(a,t))return null;let n=(0,r.createHash)("sha256").update(Math.random().toString()).digest("hex");return await s.user.update({where:{id:a.id},data:{auth_token:n,auth_token_expires:new Date(Date.now()+2592e6)}}),{id:a.id,username:a.username,email:a.email,role:a.role,token:n}}}class u{static async listClients(){return s.client.findMany({orderBy:{last_seen:"desc"},select:{id:!0,account_number:!0,account_name:!0,status:!0,balance:!0,equity:!0,open_positions:!0,last_seen:!0}})}static async findByAccountNumber(e){return s.client.findFirst({where:{account_number:e}})}static async findById(e){return s.client.findUnique({where:{id:e}})}static async registerOrUpdate(e){let t=await this.findByAccountNumber(e.account_number);if(t){if(t.auth_token!==e.auth_token)throw Error("Unauthorized - Invalid token");return await s.client.update({where:{id:t.id},data:{last_seen:new Date,balance:e.balance,equity:e.equity,open_positions:e.open_positions,account_name:e.account_name}}),{client:t,token:t.auth_token,isNew:!1}}{if(e.registration_token!==process.env.MASTER_TOKEN)throw Error("Unauthorized - Invalid registration token");let t=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return{client:await s.client.create({data:{account_number:e.account_number,account_name:e.account_name,auth_token:t,balance:e.balance,equity:e.equity,open_positions:e.open_positions,last_seen:new Date,status:"active"}}),token:t,isNew:!0}}}static async getPendingCommand(e){let t=await s.commandQueue.findFirst({where:{client_id:e,status:"pending"},orderBy:{created_at:"asc"}});return t&&await s.commandQueue.update({where:{id:t.id},data:{status:"executed",executed_at:new Date}}),t}}class c{static async getMasterState(){return s.masterState.findFirst({where:{id:1},select:{total_positions:!0,positions_json:!0,updated_at:!0}})}static async updateMasterState(e){return s.masterState.upsert({where:{id:1},update:{total_positions:e.total_positions,positions_json:e.positions_json,updated_at:new Date},create:{id:1,total_positions:e.total_positions,positions_json:e.positions_json}})}static async getPendingCommand(){let e=await s.commandQueue.findFirst({where:{client_id:0,status:"pending"},orderBy:{created_at:"asc"}});return e&&await s.commandQueue.update({where:{id:e.id},data:{status:"executed",executed_at:new Date}}),e}static async queueCommand(e,t){return s.commandQueue.create({data:{client_id:0,command:e,params:t,status:"pending"}})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[948,972,28],()=>a(735));module.exports=n})();