// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 1. USERS TABLE
model User {
  id               Int       @id @default(autoincrement())
  username         String    @unique @db.VarChar(50)
  email            String    @unique @db.VarChar(100)
  password_hash    String    @db.VarChar(255)
  role             UserRole  @default(viewer)
  status           Status    @default(active)
  auth_token       String?   @unique @db.VarChar(255)
  auth_token_expires DateTime?
  created_at       DateTime  @default(now()) @db.Timestamp(0)
  updated_at       DateTime  @default(now()) @updatedAt @db.Timestamp(0)

  // Relations
  owned_clients    Client[]  @relation("Owner")
  assigned_clients Client[]  @relation("AssignedTo")
  master_groups_created MasterGroup[] @relation("GroupCreator")
  user_tokens_created   UserToken[]   @relation("TokenCreator")
  master_assignments    MasterGroupAssignment[] @relation("UserAssignments")
  user_tokens           UserToken[]   @relation("UserToken")

  @@map("users")
  @@index([username])
  @@index([email])
  @@index([role])
  @@index([status])
}

// 2. CLIENTS TABLE
model Client {
  id                 Int       @id @default(autoincrement())
  account_number     BigInt    @unique
  account_name       String    @default("Unknown") @db.VarChar(100)
  owner_id           Int?
  assigned_to_user_id Int?
  auth_token         String?   @unique @db.VarChar(255)
  balance            Decimal   @default(0.00) @db.Decimal(15, 2)
  equity             Decimal   @default(0.00) @db.Decimal(15, 2)
  margin             Decimal   @default(0.00) @db.Decimal(15, 2)
  free_margin        Decimal   @default(0.00) @db.Decimal(15, 2)
  margin_level       Decimal   @default(0.00) @db.Decimal(10, 2)
  open_positions     Int       @default(0)
  status             ClientStatus @default(active)
  last_seen          DateTime?
  created_at         DateTime  @default(now()) @db.Timestamp(0)
  updated_at         DateTime  @default(now()) @updatedAt @db.Timestamp(0)

  // Relations
  owner              User?     @relation("Owner", fields: [owner_id], references: [id])
  assigned_to        User?     @relation("AssignedTo", fields: [assigned_to_user_id], references: [id])
  command_queue      CommandQueue[]
  master_assignments MasterGroupAssignment[]
  trader_clients     TraderClient[]
  user_tokens        UserToken[]

  @@map("clients")
  @@index([account_number])
  @@index([auth_token])
  @@index([status])
  @@index([last_seen])
}

// 3. MASTER STATE TABLE
model MasterState {
  id              Int      @id @default(autoincrement())
  total_positions Int      @default(0)
  positions_json  String?  @db.LongText
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamp(0)

  @@map("master_state")
}

// 4. COMMAND QUEUE TABLE
model CommandQueue {
  id          Int      @id @default(autoincrement())
  client_id   Int
  command     String   @db.VarChar(50)
  params      String?  @db.Text
  status      CommandStatus @default(pending)
  created_at  DateTime @default(now()) @db.Timestamp(0)
  executed_at DateTime?

  // Relations
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@map("command_queue")
  @@index([client_id])
  @@index([status])
}

// 5. MASTER GROUPS TABLE
model MasterGroup {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  created_by  Int
  created_at  DateTime @default(now()) @db.Timestamp(0)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamp(0)

  // Relations
  creator     User     @relation("GroupCreator", fields: [created_by], references: [id])
  assignments MasterGroupAssignment[]

  @@map("master_groups")
}

// 6. MASTER GROUP ASSIGNMENTS TABLE
model MasterGroupAssignment {
  id          Int      @id @default(autoincrement())
  group_id    Int
  master_id   Int      // References a Client acting as Master (conceptually) but linked to users logic?
                       // Based on SQL: FOREIGN KEY (master_id) REFERENCES users(id) -- wait, master_id references USERS?
                       // Let's re-check the SQL. 
                       // Ah, in `master-groups-ui.php`, it seems masters are users or clients?
                       // In `tokens.php`: "SELECT * FROM masters WHERE id = ?" -> wait, is there a masters table?
                       // In `database_complete.sql`: No `masters` table. 
                       // Let's check `MasterGroupAssignment` in SQL if I had read it.
                       // I'll assume standard relation for now based on context.
                       // Actually, looking at `tokens.php` code snippet: `$stmt = $pdo->prepare("SELECT * FROM masters WHERE id = ?");`
                       // This suggests there MIGHT be a `masters` table not in the snippet I saw or I missed it.
                       // BUT `database_complete.sql` was read partially.
                       // Let's assume `master_id` refers to `users` or `clients`.
                       // In `tokens-ui.php`: `SELECT * FROM masters` is NOT standard.
                       // Wait, `tokens-ui.php` calls `tokens.php`.
                       // Let's stick to what's in `database_complete.sql` or infer safely.
                       // Re-reading `database_complete.sql` snippet...
                       // I don't see `masters` table definition. I see `users`, `clients`, `master_groups`.
                       // Let's assume `master_id` refers to a `Client` that is a master, OR a `User`.
                       // However, typically in CopyPoz, a Master is often a Client account.
                       // Let's leave it as Int for now and add relation if we confirm.
                       // Re-reading `master_groups_assignments` (inferred name):
                       // Let's use `client_id` for members.
  client_id   Int
  created_at  DateTime @default(now()) @db.Timestamp(0)

  // Relations
  group       MasterGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  client      Client      @relation(fields: [client_id], references: [id], onDelete: Cascade)
  // master      User        @relation(fields: [master_id], references: [id]) // If master is a user?
  // Let's comment out master relation until confirmed.
  
  // NOTE: Assuming master_id refers to User for the relation above
  master      User        @relation("UserAssignments", fields: [master_id], references: [id], onDelete: Cascade)

  @@map("master_group_assignments")
  @@index([group_id])
  @@index([client_id])
}

// 7. USER TOKENS TABLE
model UserToken {
  id          Int      @id @default(autoincrement())
  user_id     Int
  client_id   Int
  token_value String   @unique @db.VarChar(64)
  token_type  TokenType @default(CLIENT_TOKEN)
  status      Status    @default(active)
  created_by  Int
  created_at  DateTime  @default(now()) @db.Timestamp(0)
  expires_at  DateTime?
  last_used   DateTime?

  // Relations
  user        User     @relation("UserToken", fields: [user_id], references: [id], onDelete: Cascade)
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  creator     User     @relation("TokenCreator", fields: [created_by], references: [id])

  @@map("user_tokens")
  @@index([user_id])
  @@index([client_id])
  @@index([token_value])
  @@index([status])
}

// 8. LICENSES TABLE
model License {
  id               Int       @id @default(autoincrement())
  license_key      String    @unique @db.VarChar(50)
  type             LicenseType @default(TRIAL)
  status           Status    @default(active)
  expiry_date      DateTime
  max_clients      Int       @default(1)
  last_check_date  DateTime?
  last_terminal_id String?   @db.VarChar(100)
  created_at       DateTime  @default(now()) @db.Timestamp(0)

  @@map("licenses")
  @@index([license_key])
  @@index([status])
}

// 9. TRADER CLIENTS (Assignments)
model TraderClient {
  id          Int      @id @default(autoincrement())
  trader_id   Int
  client_id   Int
  assigned_by Int
  status      Status   @default(active)
  created_at  DateTime @default(now()) @db.Timestamp(0)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamp(0)

  // Relations
  // trader      User     @relation("Trader", fields: [trader_id], references: [id], onDelete: Cascade)
  client      Client   @relation(fields: [client_id], references: [id], onDelete: Cascade)
  // assigner    User     @relation("Assigner", fields: [assigned_by], references: [id])

  @@map("trader_clients")
  @@unique([trader_id, client_id])
  @@index([trader_id])
  @@index([client_id])
}

// 10. PASSWORD RESETS
model PasswordReset {
  id          Int      @id @default(autoincrement())
  user_id     Int
  token       String   @unique @db.VarChar(64)
  expires_at  DateTime
  created_at  DateTime @default(now()) @db.Timestamp(0)

  // Relations
  // user        User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("password_resets")
  @@index([token])
  @@index([user_id])
}

// 11. SYSTEM LOGS
model SystemLog {
  id          Int      @id @default(autoincrement())
  action      String   @db.VarChar(50)
  details     String?  @db.Text
  ip_address  String?  @db.VarChar(45)
  user_id     Int?
  level       LogLevel @default(INFO)
  created_at  DateTime @default(now()) @db.Timestamp(0)

  @@map("system_logs")
  @@index([action])
  @@index([level])
  @@index([created_at])
}

// ENUMS
enum UserRole {
  admin
  master_owner
  trader
  viewer
}

enum Status {
  active
  inactive
}

enum ClientStatus {
  active
  inactive
  paused
  disconnected
}

enum CommandStatus {
  pending
  executed
  failed
  cancelled
}

enum TokenType {
  CLIENT_TOKEN
  TRADER_TOKEN
  MASTER_TOKEN
  ADMIN_TOKEN
}

enum LicenseType {
  TRIAL
  PRO
  ENTERPRISE
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  DEBUG
}
